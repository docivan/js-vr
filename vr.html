<!DOCTYPE html>
<html>
<head>
<title>VR testing</title>

<script>
var c, ctx;
var framerate = 3;
var debug = 0;

var cellw = 10;
var draw_dist = cellw * 100; //TODO should be map_side * cellw * 1.5
var ray_step = 0.5;

var px = cellw*3, py = cellw*4, pa = -Math.PI / 2; //pa = player angle
var fov = Math.PI / 4;
var bkg_grad;

var kb_left = 0, kb_right = 0, kb_up = 0, kb_down = 0, kb_a = 0, kb_z = 0;
var rot_step = Math.PI / 90;
var mv_step = 0.5;

var mm_scale = 5;

//TODO define map size!

var map = [
	//"0123456789"
	"##########", //0
	"#........#", //1
	"#..#.....#", //2
	"#........#", //3
	"#........#", //4
	"#....#...#", //5
	"#........#", //6
	"#.#......#", //7
	"#........#", //8
	"##########"  //9
];

function init() {
	c = document.getElementById("myCanvas");
	ctx = c.getContext("2d");
	
	bkg_grad=ctx.createLinearGradient(0,0,0,c.height);
	bkg_grad.addColorStop(0,"black");
	bkg_grad.addColorStop(0.5,"white");
	bkg_grad.addColorStop(1,"black");
	
	window.setInterval(function(){
		update();
	}, 1000/framerate);
	
	document.addEventListener('keydown', function(event) {
		switch(event.keyCode) {
			case 37: kb_left = 1; break;
			case 38: kb_up = 1; break;
			case 39: kb_right = 1; break;
			case 40: kb_down = 1; break;
			case 65: kb_a = 1; break;
			case 90: kb_z = 1; break;
		}
	});
	
	document.addEventListener('keyup', function(event) {
		switch(event.keyCode) {
			case 37: kb_left = 0; break;
			case 38: kb_up = 0; break;
			case 39: kb_right = 0; break;
			case 40: kb_down = 0; break;
			case 65: kb_a = 0; break;
			case 90: kb_z = 0; break;
		}
	});
}

function detect_collision(x, y) {
	var arr_x = Math.floor(x / cellw);
	var arr_y = Math.floor(y / cellw);
	
	if(arr_x <0 || arr_y <0) //out of bounds
		return 1;
	
	if(map[parseInt(arr_y)][parseInt(arr_x)] == "#")
		return 1; // hit
	else
		return 0;
}

function handle_kb() {
	if(kb_a)
		fov += rot_step;
	if(kb_z)
		fov -= rot_step;
	
	if(kb_left)
		pa -= rot_step;
	if(kb_right)
		pa += rot_step;
	
	if(kb_up) {
		px += mv_step * Math.cos(pa);
		py += mv_step * Math.sin(pa);
	}
	
	if(kb_down) {
		px -= mv_step * Math.cos(pa);
		py -= mv_step * Math.sin(pa);
	}
}

function draw_minimap () {
	var mm_x = c.width - mm_scale*10;
	var mm_y = c.height - mm_scale*10;
	
	for(var y=0; y<10; y++)
		for(var x=0; x<10; x++) {
			if(map[y][x] == "#")
				ctx.fillStyle = "#000000";
			else
				ctx.fillStyle = "#ffffff";
			
			ctx.fillRect(mm_x + x*mm_scale, mm_y + y*mm_scale, mm_scale, mm_scale);
		}
	
	var mm_px = mm_x + px / (10*cellw) * (10*mm_scale);
	var mm_py = mm_y + py / (10*cellw) * (10*mm_scale);
	
	//draw angle..
	var mm_pax = mm_scale * Math.cos(pa);
	var mm_pay = mm_scale * Math.sin(pa);
	
	ctx.strokeStyle="#0000ff";
	ctx.beginPath();
	ctx.moveTo(mm_px, mm_py);
	ctx.lineTo(mm_px + mm_pax, mm_py + mm_pay);
	ctx.stroke();
	
	//draw player..
	ctx.fillStyle = "#ff0000";		
	ctx.fillRect(mm_px - mm_scale/4, mm_py - mm_scale/4, mm_scale/2, mm_scale/2);
}

function update() {
	ctx.fillStyle=bkg_grad;
	ctx.fillRect(0,0,c.width,c.height);
	
	//pa += Math.PI / 180;
	
	handle_kb();
	
	for(var i = 0; i<c.width; i++) {
		var ray_a = (pa - fov / 2) + (i/c.width)*fov;
		
		var dist = 0;
		var vx = Math.cos(ray_a);
		var vy = Math.sin(ray_a);
		
		while (dist < draw_dist) {
			dist += ray_step;
			
			var testx = px + vx*dist;
			var testy = py + vy*dist;
			
			if( detect_collision(testx, testy) )
				break;
		}
		
		
		var ceil_y = c.height / 2 - c.height / dist; //if dist = 1 => negative
		if(ceil_y < 0)
			ceil_y=0;
		
		var floor_y = c.height - ceil_y;
		var col = parseInt(255 - 255 * ceil_y/(c.height/2) ).toString(16);
		if(col.length < 2)
			col = "0" + col;
		
		ctx.fillStyle="#0000" + col;
		ctx.fillRect(i, ceil_y, 1, floor_y-ceil_y);
		
		//if(i == 0)
			//console.log("#0000" + col + " : " + ceil_y.toString() + " : " + (floor_y - ceil_y).toString());
	}
	
	draw_minimap();
}

</script> 

</head>

<body onload="init()">
<canvas id="myCanvas" width="400" height="400" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>
</body>
</html>

